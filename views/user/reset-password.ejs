<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Reset Password</title>
    <link rel="icon" type="image/svg+xml" href="/imgs/theme/kaizenicon.svg">
    <link rel="stylesheet" href="/css/main.css?v=3.4">
    <link rel="stylesheet" href="/css/res-passwordUser.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.4.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .swal2-popup.swal-responsive {
            color: #333 !important;
            border: 2px solid rgba(0, 0, 0, 0.1) !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15) !important;
            backdrop-filter: blur(10px) !important;
        }
    
        .swal2-title {
            color: #e74c3c !important;
            font-weight: 600 !important;
            text-shadow: none !important;
        }
    
        .swal2-content {
            color: #666 !important;
        }
    
        .swal2-confirm {
            background: #3BB77E !important;
            border: none !important;
            border-radius: 8px !important;
            padding: 12px 30px !important;
            font-weight: 600 !important;
            color: white !important;
            box-shadow: 0 4px 15px rgba(59, 183, 126, 0.3) !important;
            transition: all 0.3s ease !important;
        }
    
        .swal2-confirm:hover {
            background: #2a9d5f !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 6px 20px rgba(59, 183, 126, 0.4) !important;
        }
    
        .swal2-icon.swal2-error {
            border-color: #e74c3c !important;
            color: #e74c3c !important;
        }
    
        .swal2-icon.swal2-error .swal2-x-mark {
            color: #e74c3c !important;
        }
    
        .swal-responsive {
            width: 90% !important;
            max-width: 320px !important;
            padding: 1.2rem !important;
            border-radius: 10px;
            font-size: 0.95rem;
        }
    </style>
</head>
<body>
    <main class="main">
        <section class="signup-wrapper">
            <div class="container">
                <div class="signup-card mx-auto">
                    <div class="row g-0">

                        <div class="col-lg-6 signup-form-col">
                            <div class="p-4 p-lg-5">
                                <div class="logo-signup-img">
                                    <a href="#"><img src="/imgs/theme/kaizenlogoo.svg" alt="logo"></a>
                                </div>
                                <h3 class="signup-headline mb-4">Reset your password</h3>
                                <p>Enter a new password:</p>

                                <form id="resetForm" novalidate>
                                    <input type="hidden" name="email" value="<%= email %>">

                                    <div class="mb-3">
                                        <input type="password" id="password" name="password" placeholder="New Password"
                                            required class="form-control signup-input" />
                                        <div id="passwordError" class="error-text">
                                            Password must be 8+ chars, include uppercase, lowercase, number, and special
                                            char.
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <input type="password" id="confirmPassword" name="confirmPassword"
                                            placeholder="Confirm Password" required class="form-control signup-input" />
                                        <div id="confirmError" class="error-text">
                                            Passwords do not match.
                                        </div>
                                    </div>

                                    <div class="d-grid mb-4">
                                        <button type="submit" class="btn btn-signup">
                                            Reset
                                        </button>
                                    </div>

                                    <p class="text-center mt-4 text-muted">
                                        <a href="/login" class="link-login">Back to login</a>
                                    </p>
                                </form>
                            </div>
                        </div>

                        <div class="col-lg-6 signup-form-col">
                            <div class="p-4 p-lg-5 text-center">
                                <img src="/imgs/anime/reset-password.png" alt="Reset Password Banner"
                                    class="img-fluid rounded" style="max-width: 65%; height: auto; margin-top: 80px;" />
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        document.getElementById('resetForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('confirmError').style.display = 'none';

            const form = e.target;
            const email = form.email.value;
            const password = form.password.value;
            const confirm = form.confirmPassword.value;

            const strongRe = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z\d]).{8,}$/;
            let hasError = false;

            if (!strongRe.test(password)) {
                document.getElementById('passwordError').style.display = 'block';
                hasError = true;
            }

            if (password !== confirm) {
                document.getElementById('confirmError').style.display = 'block';
                hasError = true;
            }

            if (hasError) return;

            try {
                const res = await fetch('/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, confirmPassword: confirm })
                });

                const result = await res.json();

                if (!res.ok) throw new Error(result.message || 'Reset failed');

                await Swal.fire({
                    icon: 'success',
                    title: 'Password Updated!',
                    text: result.message,
                    confirmButtonText: 'Login',
                    customClass: {
                        popup: 'swal-responsive'
                    }
                });

                window.location.href = '/login';
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: err.message,
                    customClass: {
                        popup: 'swal-responsive'
                    }
                });
            }
        });
    </script>
</body>

</html>