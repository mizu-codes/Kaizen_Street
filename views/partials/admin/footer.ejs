<div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crop Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="crop-container">
                    <img id="cropImage" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelCrop">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" id="cropAndSave">
                    Crop & Save
                </button>
            </div>
        </div>
    </div>
</div>
<footer class="main-footer font-xs text-center py-3">
    <div>&copy;
        <script>document.write(new Date().getFullYear())</script> Kaizen Street. All rights reserved.
    </div>
</footer>
</main>

<script src="/assets2/js/vendors/jquery-3.6.0.min.js"></script>
<script src="/assets2/js/vendors/bootstrap.bundle.min.js"></script>
<script src="/assets/js/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js" integrity="sha512-..." crossorigin="anonymous"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        let cropper = null;
        let currentSlot = null;

        window.triggerFile = i => {
            const input = document.getElementById(`fileInput${i}`);
            if (!input) return console.warn('file input not found for slot', i);
            input.setAttribute('accept', 'image/*'); // keep hint
            input.click();
        };

        function isImageFile(file) {
            if (!file) return false;
            if (file.type && file.type.startsWith('image/')) return true;
            return /\.(jpe?g|png|gif|webp|svg)$/i.test(file.name);
        }

        window.loadCropper = (e, i) => {
            currentSlot = i;
            const fileInput = e.target;
            const file = fileInput && fileInput.files && fileInput.files[0];
            if (!file) return;

            const isByType = file.type && file.type.startsWith('image/');
            const isByExt = /\.(jpe?g|png|gif|webp|svg)$/i.test(file.name);
            if (!isByType && !isByExt) {
                try { fileInput.value = ''; } catch (err) { }

                const msg = 'Please select an image file (jpg, png, gif, webp, svg).';
                if (typeof Swal !== 'undefined') {
                    Swal.fire({ icon: 'error', title: 'Invalid file', text: msg, customClass: { popup: 'swal-responsive'}});
                } else {
                    alert(msg);
                }
                return;
            }

            const imgEl = document.getElementById('cropImage');
            if (!imgEl) {
                console.error('cropImage element not found');
                return;
            }
            try {
                const url = URL.createObjectURL(file);
                imgEl.src = url;
            } catch (error) {
                console.error('Could not create object URL for image', error);
                return;
            }

            const modalEl = document.getElementById('cropModal');
            if (!modalEl) {
                console.error('cropModal element not found');
                return;
            }
            const bsModal = new bootstrap.Modal(modalEl);
            bsModal.show();

            modalEl.addEventListener('shown.bs.modal', () => {
                try {
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imgEl, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 1,
                    });
                } catch (err) {
                    console.error('Cropper init error', err);
                }
            }, { once: true });
        };

        const cancelEl = document.getElementById('cancelCrop');
        if (cancelEl) {
            cancelEl.addEventListener('click', () => {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            });
        }

        const saveEl = document.getElementById('cropAndSave');
        if (saveEl) {
            saveEl.addEventListener('click', () => {
                if (!cropper || currentSlot == null) return;

                cropper.getCroppedCanvas({ width: 800, height: 800 }).toBlob(blob => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const dataURL = reader.result;

                        const hidden = document.getElementById(`croppedImage${currentSlot}`);
                        if (hidden) hidden.value = dataURL;

                        const slot = document.getElementById(`slot-${currentSlot}`);
                        if (slot) {
                            const img = slot.querySelector('img');
                            if (img) img.src = dataURL;
                            const btn = slot.querySelector('button');
                            if (btn) btn.style.display = 'none';
                            slot.classList.add('has-image');
                        }

                        try { if (typeof updateState === 'function') updateState(); } catch (err) { }

                        const modal = document.getElementById('cropModal');
                        const bs = bootstrap.Modal.getInstance(modal);
                        if (bs) bs.hide();
                    };
                    reader.readAsDataURL(blob);

                    try {
                        cropper.destroy();
                        cropper = null;
                    } catch (err) { }
                }, 'image/jpeg', 0.85);
            });
        } else {
            console.warn('Save button with id "cropAndSave" not found â€” please ensure your modal save button has id="cropAndSave"');
        }

        const addForm = document.getElementById('productAddForm');
        const submitBtn = document.getElementById('submitBtn');

        if (!addForm || !submitBtn) {
            console.error('Form or submit button not found! Make sure IDs match.');
            return;
        }

        function updateState() {
            const allImages = [0, 1, 2].every(i =>
                !!document.getElementById(`croppedImage${i}`).value
            );

            const fields = ['productName', 'regularPrice', 'status', 'category'];
            const sizeFields = ['S', 'M', 'L', 'XL', 'XXL'].map(s => document.getElementById(`stock_${s}`));
            const oneSizeHasStock = sizeFields.some(input => parseInt(input.value) > 0);

            const allFields = fields.every(id =>
                document.getElementById(id).value.trim() !== ''
            );

            const ok = allImages && allFields && oneSizeHasStock;
            submitBtn.disabled = !ok;
            const imgErr = document.getElementById('img-error');
            if (imgErr) imgErr.style.display = allImages ? 'none' : 'block';
        }

        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('input', updateState);
            el.addEventListener('change', updateState);
        });

        updateState();

        addForm.addEventListener('submit', (e) => {
            if (submitBtn.disabled) {
                console.warn('Duplicate submit blocked');
                e.preventDefault();
                return;
            }

            submitBtn.disabled = true;
        });

    });


    const regInput = document.getElementById('regularPrice');
    const offInput = document.getElementById('productOffer');
    const discHidden = document.getElementById('discountPrice');
    const submitBtn = document.getElementById('submitBtn');

    function recalc() {
        const base = parseFloat(regInput.value) || 0;
        const pct = parseFloat(offInput.value) || 0;

        const clamped = Math.min(Math.max(pct, 0), 100);

        const discounted = base * (1 - clamped / 100);
        discHidden.value = discounted.toFixed(2);


        submitBtn.disabled = !(base > 0 && clamped >= 0);
    }

    regInput.addEventListener('input', recalc);
    offInput.addEventListener('input', recalc);


    recalc();
</script>
</body>

</html>