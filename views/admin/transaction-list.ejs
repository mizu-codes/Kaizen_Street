<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Transactions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <link rel="icon" type="image/svg+xml" href="/assets2/imgs/theme/kaizenicon.svg">
  <link href="/assets2/css/main.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .logout-fixed {
      position: fixed;
      top: 15px;
      right: 20px;
      z-index: 1031;
    }

    .logout-fixed .nav {
      display: flex;
      margin: 0;
    }

    .logout-fixed .nav-item {
      list-style: none;
    }

    .main-header {
      display: flex !important;
      align-items: center !important;
      flex-wrap: wrap !important;
      position: relative;
      gap: 10px;
    }

    .main-header .col-search {
      flex: 1 1 100%;
      min-width: 200px;
      margin: 0 !important;
      padding: 0 !important;
      order: 3;
    }

    .searchform {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: nowrap;
    }

    .searchform .form-control {
      flex: 1;
      min-width: 150px;
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 5px 10px;
      flex-shrink: 0;
      order: 1;
    }

    @media (max-width: 991px) {
      .navbar-aside {
        position: fixed !important;
        left: 0;
        top: 0;
        width: 260px;
        height: 100vh;
        z-index: 1045;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        background: white;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      }

      .navbar-aside.show {
        transform: translateX(0);
      }

      .screen-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        display: none !important;
      }

      .screen-overlay.show {
        display: block !important;
      }

      .main-wrap {
        margin-left: 0 !important;
      }

      .main-header {
        position: sticky;
        top: 0;
        z-index: 1030;
        flex-wrap: wrap;
      }

      .main-header .col-search {
        flex: 1 1 100%;
        order: 3;
        margin-top: 10px !important;
      }

      .mobile-menu-btn {
        display: block !important;
        order: 1;
      }
    }

    @media (max-width: 767px) {

      .col-lg-3,
      .col-md-6 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
      }

      .col-xl-8 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
      }

      .col-xl-4 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
      }

      .col-xl-6 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
      }

      .card {
        margin-bottom: 15px;
      }

      .table-responsive {
        font-size: 12px;
      }

      .searchform {
        flex-wrap: wrap;
      }

      .searchform .form-control {
        min-width: 100%;
      }

      .main-header .col-search {
        flex: 1 1 100%;
        margin-top: 10px !important;
      }
    }

    .content-header .btn-add {
      background-color: #6c63ff;
      color: #fff;
    }

    .content-header .btn-add:hover {
      background-color: #5a52d4;
    }

    .table-wrap {
      overflow-x: auto;
    }

    .table-custom th {
      background: linear-gradient(90deg, #6c63ff, #8f94fb);
      color: #fff;
      border: none;
      padding: 12px 10px;
    }

    .table-custom td {
      vertical-align: middle;
      white-space: nowrap;
      padding: 6px;
    }

    .table-custom tbody tr:hover {
      background-color: #f1f1f1;
    }

    .pagination .page-link {
      color: #6c63ff;
      border-radius: 8px;
      border: 1px solid #6c63ff;
      margin: 0 4px;
      transition: 0.3s ease;
    }

    .pagination .page-link:hover {
      background-color: #6c63ff;
      color: white;
    }

    .pagination .page-item.active .page-link {
      background-color: #6c63ff;
      border-color: #6c63ff;
      color: white;
    }

    .pagination .page-item.disabled .page-link {
      color: #aaa;
      border-color: #ddd;
      background-color: #f9f9f9;
    }

    .type-order {
      background: #007bff;
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.775rem;
      font-weight: 500;
    }

    .type-refund {
      background: #28a745;
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.775rem;
      font-weight: 500;
    }

    .type-wallet-topup {
      background: #0dcaf0;
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.775rem;
      font-weight: 500;
    }

    .method-razorpay,
    .method-wallet,
    .method-cod {
      color: #fff;
      padding: 0.4rem 1rem;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.06);
      transition: transform .12s ease, box-shadow .12s ease;
      font-weight: 600;
      text-decoration: none;
    }

    .method-razorpay {
      background: linear-gradient(135deg, #012652 0%, #0D94FB 100%);
      box-shadow: 0 6px 18px rgba(13, 148, 251, 0.16);
    }

    .method-razorpay:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(13, 148, 251, 0.18);
    }

    .method-wallet {
      background: linear-gradient(145deg, #ff9a9e 0%, #fecfef 100%);
      box-shadow: 0 6px 18px rgba(255, 154, 158, 0.14);
      color: #fff;
    }

    .method-wallet:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(255, 154, 158, 0.18);
    }

    .method-cod {
      background: linear-gradient(135deg, #ff8c00 0%, #ffd54f 100%);
      box-shadow: 0 6px 18px rgba(255, 173, 51, 0.14);
    }

    .method-cod:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(255, 173, 51, 0.18);
    }

    .amount-positive {
      color: #28a745;
      font-weight: 600;
    }

    .amount-negative {
      color: #dc3545;
      font-weight: 600;
    }

    .amount-neutral {
      color: #007bff;
      font-weight: 600;
    }

    td {
      vertical-align: top;
      padding: 12px 8px;
    }

    .filter-dropdown {
      min-width: 150px;
    }

    .transaction-id,
    .order-id {
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      color: #6c757d;
      font-weight: bold;
    }

    .user-info strong {
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <div class="screen-overlay" id="screenOverlay"></div>
  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
      <a href="/admin" class="brand-wrap">
        <img src="/assets2/imgs/theme/kaizenlogoo.svg" class="logo" alt="Kaizen Dashboard">
      </a>
      <div>
        <button class="btn btn-icon btn-aside-minimize">
          <i class="text-muted material-icons md-menu_open"></i>
        </button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item">
          <a class="menu-link" href="/admin"> <i class="icon material-icons md-home"></i>
            <span class="text">Dashboard</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/user"> <i class="icon material-icons md-person"></i>
            <span class="text">Customers</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/category"> <i class="icon material-icons md-store"></i>
            <span class="text">Category</span>
          </a>
        </li>
        <li class="menu-item has-submenu">
          <a class="menu-link"><i class="icon material-icons md-shopping_bag"></i>
            <span class="text">Products</span>
          </a>
          <div class="submenu">
            <a href="/admin/addProducts">Product Add</a>
            <a href="/admin/products">Product List</a>
          </div>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/orders">
            <i class="icon material-icons md-shopping_cart"></i>
            <span class="text">Orders</span>
          </a>
        </li>
        <li class="menu-item active">
          <a class="menu-link" href="/admin/transactions">
            <i class="icon material-icons md-account_balance_wallet"></i>
            <span class="text">Transactions</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/coupons">
            <i class="icon material-icons md-local_offer"></i>
            <span class="text">Coupons</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/sales-report">
            <i class="icon material-icons md-assessment"></i>
            <span class="text">Sales Report</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <main class="main-wrap">
    <% const _page=typeof page !=='undefined' ? page : 1; const _limit=typeof limit !=='undefined' ? limit :
      transactions.length || 1; const _q=typeof q !=='undefined' ? q : '' ; const _method=typeof method !=='undefined' ?
      method : '' ; const _type=typeof type !=='undefined' ? type : '' ; const _msg=typeof message !=='undefined' ?
      message : '' ; %>
      <header class="main-header navbar">
        <button class="mobile-menu-btn" id="mobileMenuBtn">
          <i class="fas fa-bars"></i>
        </button>
        <div class="col-search">
          <form id="transactionFilterForm" class="searchform d-flex" action="/admin/transactions" method="GET">
            <input type="hidden" name="page" id="pageInput" value="1">

            <div class="dropdown me-2">
              <select name="method" class="form-select filter-dropdown"
                onchange="document.getElementById('transactionFilterForm').submit()">
                <option value="all" <%=(!_method || _method==='all' ) ? 'selected' : '' %>>All Methods</option>
                <option value="razorpay" <%=_method==='razorpay' ? 'selected' : '' %>>Razorpay</option>
                <option value="cod" <%=_method==='cod' ? 'selected' : '' %>>COD</option>
                <option value="wallet" <%=_method==='wallet' ? 'selected' : '' %>>Wallet</option>
              </select>
            </div>

            <div class="dropdown me-2">
              <select name="type" class="form-select filter-dropdown"
                onchange="document.getElementById('transactionFilterForm').submit()">
                <option value="all" <%=(!_type || _type==='all' ) ? 'selected' : '' %>>All Types</option>
                <option value="order_payment" <%=_type==='order_payment' ? 'selected' : '' %>>Orders</option>
                <option value="refund" <%=_type==='refund' ? 'selected' : '' %>>Refunds</option>
                <option value="wallet_topup" <%=_type==='wallet_topup' ? 'selected' : '' %>>Wallet Top-up</option>
              </select>
            </div>

            <input type="text" name="q" value="<%= _q || '' %>" class="form-control"
              placeholder="Search by user name, email, or transaction ID" />

            <button class="btn btn-light ms-2" type="submit">
              <i class="material-icons md-search"></i>
            </button>

            <% if ((_q && _q.trim()) || (_method && _method !=='all' ) || (_type && _type !=='all' )) { %>
              <a href="/admin/transactions" class="btn btn-outline-secondary ms-2" style="font-size:1rem;">Clear</a>
              <% } %>
          </form>
        </div>
      </header>
     
      <div class="logout-fixed">
        <ul class="nav">
          <li class="dropdown nav-item">
            <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount">
              <img class="img-xs rounded-circle" src="/assets2/imgs/theme/adminAvatar.svg" alt="Admin">
            </a>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
              <a class="dropdown-item text-danger" href="/admin/logout">
                <i class="material-icons md-exit_to_app"></i>Logout
              </a>
            </div>
          </li>
        </ul>
      </div>

      <section class="content-main">
        <div class="content-header d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="content-title card-title">Transaction Management</h2>
            <p class="text-muted">Total: <%= totalTransactions || 0 %> transactions</p>
          </div>
        </div>
        <div class="card mb-4">
          <div class="card-body">
            <div class="table-wrap">
              <table class="table table-custom align-middle mb-0">
                <thead>
                  <tr>
                    <th>SL No</th>
                    <th>Transaction ID</th>
                    <th>User Name</th>
                    <th>Order ID</th>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Method</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (transactions.length) { %>
                    <% transactions.forEach((transaction, i)=> { %>
                      <tr>
                        <td>
                          <%= (page - 1) * limit + i + 1 %>
                        </td>
                        <td>
                          <div class="transaction-id">
                            #<%= transaction._id.toString().slice(-8).toUpperCase() %>
                          </div>
                        </td>
                        <td>
                          <div class="user-info">
                            <strong>
                              <%= transaction.customerId?.name || '—' %>
                            </strong>
                            <% if (transaction.customerId?.email) { %>
                              <br><small class="text-muted">
                                <%= transaction.customerId.email %>
                              </small>
                              <% } %>
                          </div>
                        </td>
                        <td>
                          <% if (transaction.isWalletTransaction) { %>
                            <span class="text-muted"></span>
                            <small class="d-block text-info">Wallet Transaction</small>
                            <% } else if (transaction.displayOrderId) { %>
                              <span class="order-id">#<%= transaction.displayOrderId %></span>
                              <% } else { %>
                                <span class="text-muted">—</span>
                                <% } %>
                        </td>
                        <td>
                          <%= new Date(transaction.createdAt).toLocaleDateString() %><br>
                            <small class="text-muted">
                              <%= new Date(transaction.createdAt).toLocaleTimeString() %>
                            </small>
                        </td>
                        <td>
                          <% if (transaction.type==='order_payment' ) { %>
                            <span class="type-order">Ordered</span>
                            <% } else if (transaction.type==='refund' ) { %>
                              <span class="type-refund">Refund</span>
                              <% } else if (transaction.type==='wallet_topup' ) { %>
                                <span class="type-wallet-topup">Top-up</span>
                                <% } else { %>
                                  <span class="badge bg-secondary">
                                    <%= transaction.type || 'Other' %>
                                  </span>
                                  <% } %>
                        </td>
                        <td>
                          <% const amount=transaction.amount || 0; %>
                            <% if (transaction.type==='refund' ) { %>
                              <span class="text-success fw-bold">+₹<%= amount.toLocaleString() %></span>
                              <% } else if (transaction.type==='order_payment' ) { %>
                                <span class="text-danger fw-bold">-₹<%= amount.toLocaleString() %></span>
                                <% } else if (transaction.type==='wallet_topup' ) { %>
                                  <span class="text-primary fw-bold">+₹<%= amount.toLocaleString() %></span>
                                  <% } else { %>
                                    <span class="fw-bold">₹<%= amount.toLocaleString() %></span>
                                    <% } %>
                        </td>
                        <td>
                          <% const method=transaction.paymentMethod || 'unknown' ; %>
                            <% if (method==='razorpay' ) { %>
                              <span class="method-razorpay">Razorpay</span>
                              <% } else if (method==='cod' ) { %>
                                <span class="method-cod">COD</span>
                                <% } else if (method==='wallet' ) { %>
                                  <span class="method-wallet">Wallet</span>
                                  <% } else { %>
                                    <span class="badge bg-light text-dark">
                                      <%= method %>
                                    </span>
                                    <% } %>
                        </td>
                        <td>
                          <% const status=transaction.status || 'completed' ; %>
                            <% if (status==='completed' || status==='paid' ) { %>
                              <span class="badge bg-success">Completed</span>
                              <% } else if (status==='pending' ) { %>
                                <span class="badge bg-warning">Pending</span>
                                <% } else if (status==='failed' ) { %>
                                  <span class="badge bg-danger">Failed</span>
                                  <% } else { %>
                                    <span class="badge bg-secondary">
                                      <%= status %>
                                    </span>
                                    <% } %>
                        </td>
                      </tr>
                      <% }) %>
                        <% } else { %>
                          <tr>
                            <td colspan="9" class="text-center text-warning py-4">
                              No transactions found.
                              <% if ((q && q.trim()) || (method && method !=='all' ) || (type && type !=='all' )) { %>
                                <br><small>Try adjusting your search or filter criteria.</small>
                                <% } %>
                            </td>
                          </tr>
                          <% } %>
                </tbody>
              </table>

              <% if (typeof totalPages !=='undefined' && totalPages> 1) { %>
                <nav aria-label="Page navigation">
                  <ul class="pagination justify-content-center mt-4">
                    <li class="page-item <%= page <= 1 ? 'disabled' : '' %>">
                      <a class="page-link"
                        href="/admin/transactions?<%= q ? 'q=' + encodeURIComponent(q) + '&' : '' %><%= method && method !== 'all' ? 'method=' + method + '&' : '' %><%= type && type !== 'all' ? 'type=' + type + '&' : '' %>page=<%= page - 1 %>&limit=<%= limit %>">
                        <i class="material-icons" style="font-size:16px;"></i> Prev
                      </a>
                    </li>

                    <% const startPage=Math.max(1, page - 2); const endPage=Math.min(totalPages, page + 2); %>

                      <% if (startPage> 1) { %>
                        <li class="page-item">
                          <a class="page-link"
                            href="/admin/transactions?<%= q ? 'q=' + encodeURIComponent(q) + '&' : '' %><%= method && method !== 'all' ? 'method=' + method + '&' : '' %><%= type && type !== 'all' ? 'type=' + type + '&' : '' %>page=1&limit=<%= limit %>">1</a>
                        </li>
                        <% if (startPage> 2) { %>
                          <li class="page-item disabled"><span class="page-link">...</span></li>
                          <% } %>
                            <% } %>

                              <% for (let p=startPage; p <=endPage; p++) { %>
                                <li class="page-item <%= p === page ? 'active' : '' %>">
                                  <a class="page-link"
                                    href="/admin/transactions?<%= q ? 'q=' + encodeURIComponent(q) + '&' : '' %><%= method && method !== 'all' ? 'method=' + method + '&' : '' %><%= type && type !== 'all' ? 'type=' + type + '&' : '' %>page=<%= p %>&limit=<%= limit %>">
                                    <%= p %>
                                  </a>
                                </li>
                                <% } %>

                                  <% if (endPage < totalPages) { %>
                                    <% if (endPage < totalPages - 1) { %>
                                      <li class="page-item disabled"><span class="page-link">...</span></li>
                                      <% } %>
                                        <li class="page-item">
                                          <a class="page-link"
                                            href="/admin/transactions?<%= q ? 'q=' + encodeURIComponent(q) + '&' : '' %><%= method && method !== 'all' ? 'method=' + method + '&' : '' %><%= type && type !== 'all' ? 'type=' + type + '&' : '' %>page=<%= totalPages %>&limit=<%= limit %>">
                                            <%= totalPages %>
                                          </a>
                                        </li>
                                        <% } %>

                                          <li class="page-item <%= page >= totalPages ? 'disabled' : '' %>">
                                            <a class="page-link"
                                              href="/admin/transactions?<%= q ? 'q=' + encodeURIComponent(q) + '&' : '' %><%= method && method !== 'all' ? 'method=' + method + '&' : '' %><%= type && type !== 'all' ? 'type=' + type + '&' : '' %>page=<%= page + 1 %>&limit=<%= limit %>">
                                              Next <i class="material-icons" style="font-size:16px;"></i>
                                            </a>
                                          </li>
                  </ul>
                </nav>
                <% } %>
            </div>
          </div>
        </div>
      </section>

      <footer class="main-footer font-xs text-center py-3">
        <div>&copy;
          <script>
            document.write(new Date().getFullYear())
          </script> Kaizen Street. All rights reserved.
        </div>
      </footer>
  </main>
  <script src="/assets2/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="/assets2/js/vendors/bootstrap.bundle.min.js"></script>
  <script src="/assets2/js/vendors/select2.min.js"></script>
  <script src="/assets2/js/vendors/perfect-scrollbar.js"></script>
  <script src="/assets2/js/vendors/jquery.fullscreen.min.js"></script>
  <script src="/assets2/js/main.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('offcanvas_aside');
    const overlay = document.getElementById('screenOverlay');

    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', function (e) {
        e.preventDefault();
        sidebar.classList.toggle('show');
        overlay.classList.toggle('show');
      });
    }

    if (overlay) {
      overlay.addEventListener('click', function () {
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
      });
    }

    document.querySelectorAll('.menu-link').forEach(link => {
      link.addEventListener('click', function () {
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
      });
    });
  </script>

</body>

</html>