<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Category</title>
    <link rel="icon" type="image/svg+xml" href="/assets2/imgs/theme/kaizenicon.svg">
    <link href="/assets2/css/main.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    .logout-fixed {
      position: fixed;
      top: 15px;
      right: 20px;
      z-index: 1031;
    }
  
    .logout-fixed .nav {
      display: flex;
      margin: 0;
    }
  
    .logout-fixed .nav-item {
      list-style: none;
    }
  
    .main-header {
      display: flex !important;
      align-items: center !important;
      flex-wrap: wrap !important;
      position: relative;
      gap: 10px;
    }
  
    .main-header .col-search {
      flex: 1 1 100%;
      min-width: 200px;
      margin: 0 !important;
      padding: 0 !important;
      order: 3;
    }
  
    .searchform {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: nowrap;
    }
  
    .searchform .form-control {
      flex: 1;
      min-width: 150px;
    }
  
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 5px 10px;
      flex-shrink: 0;
      order: 1;
    }
  
    @media (max-width: 991px) {
      .navbar-aside {
        position: fixed !important;
        left: 0;
        top: 0;
        width: 260px;
        height: 100vh;
        z-index: 1045;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        background: white;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      }
  
      .navbar-aside.show {
        transform: translateX(0);
      }
  
      .screen-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        display: none !important;
      }
  
      .screen-overlay.show {
        display: block !important;
      }
  
      .main-wrap {
        margin-left: 0 !important;
      }
  
      .main-header {
        position: sticky;
        top: 0;
        z-index: 1030;
        flex-wrap: wrap;
      }
  
      .main-header .col-search {
        flex: 1 1 100%;
        order: 3;
        margin-top: 10px !important;
      }
  
      .mobile-menu-btn {
        display: block !important;
        order: 1;
      }
    }
  
    @media (max-width: 767px) {
  
      .col-lg-3,
      .col-md-6 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
      }
  
      .col-xl-8 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
      }
  
      .col-xl-4 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
      }
  
      .col-xl-6 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
      }
  
      .card {
        margin-bottom: 15px;
      }
  
      .table-responsive {
        font-size: 12px;
      }
  
      .searchform {
        flex-wrap: wrap;
      }
  
      .searchform .form-control {
        min-width: 100%;
      }
  
      .main-header .col-search {
        flex: 1 1 100%;
        margin-top: 10px !important;
      }
    }
  
    .swal-responsive {
      width: 90% !important;
      max-width: 320px !important;
      padding: 1.2rem !important;
      border-radius: 10px;
      font-size: 0.95rem;
    }
  
    .swal2-popup.swal-responsive {
      color: #333 !important;
      border: 2px solid rgba(0, 0, 0, 0.1) !important;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15) !important;
      backdrop-filter: blur(10px) !important;
    }
  
    .swal2-title {
      color: #e74c3c !important;
      font-weight: 600 !important;
      text-shadow: none !important;
    }
  
    .swal2-content {
      color: #666 !important;
    }
  
    .swal2-confirm {
      background: #3BB77E !important;
      border: none !important;
      border-radius: 8px !important;
      padding: 12px 30px !important;
      font-weight: 600 !important;
      color: white !important;
      box-shadow: 0 4px 15px rgba(59, 183, 126, 0.3) !important;
      transition: all 0.3s ease !important;
    }
  
    .swal2-confirm:hover {
      background: #2a9d5f !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 6px 20px rgba(59, 183, 126, 0.4) !important;
    }
  
    .swal2-icon.swal2-error {
      border-color: #e74c3c !important;
      color: #e74c3c !important;
    }
  
    .swal2-icon.swal2-error .swal2-x-mark {
      color: #e74c3c !important;
    }
  
    .table-wrap {
      overflow-x: auto;
    }
  
    .table-custom th {
      background: linear-gradient(90deg, #6c63ff, #8f94fb);
      color: #fff;
      border: none;
    }
  
    .table-custom tbody tr:hover {
      background-color: #f1f1f1;
    }
  
    .pagination .page-link {
      color: #6c63ff;
      border-radius: 8px;
      border: 1px solid #6c63ff;
      margin: 0 4px;
      transition: 0.3s ease;
    }
  
    .pagination .page-link:hover {
      background-color: #6c63ff;
      color: white;
    }
  
    .pagination .page-item.active .page-link {
      background-color: #6c63ff;
      border-color: #6c63ff;
      color: white;
    }
  
    .pagination .page-item.disabled .page-link {
      color: #aaa;
      border-color: #ddd;
      background-color: #f9f9f9;
    }
  
    .btn-sm {
      font-size: 0.75rem;
      padding: 0.15rem 0.65rem;
    }
  
    .offer-badge {
      background: pink;
      color: white;
      padding: 2px 5px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: bold;
      display: inline-block;
    }
  
    .add-offer-btn {
      background: #2b8a8e;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      cursor: pointer;
    }
  
    .add-offer-btn:hover {
      background: #1e6a6e;
    }
  
    .remove-offer-btn {
      background: transparent;
      border: none;
      color: #dc3545;
      font-size: 1.2rem;
      margin-left: 2px;
      cursor: pointer;
    }
  </style>
</head>

<body>
   <div class="screen-overlay" id="screenOverlay"></div>
  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
      <a href="/#" class="brand-wrap">
        <img src="/assets2/imgs/theme/kaizenlogoo.svg" class="logo" alt="Kaizen Dashboard">
      </a>
      <div>
        <button class="btn btn-icon btn-aside-minimize">
          <i class="text-muted material-icons md-menu_open"></i>
        </button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item">
          <a class="menu-link" href="/admin"> <i class="icon material-icons md-home"></i>
            <span class="text">Dashboard</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/user"> <i class="icon material-icons md-person"></i>
            <span class="text">Customers</span>
          </a>
        </li>
        <li class="menu-item active">
          <a class="menu-link" href="/admin/category"> <i class="icon material-icons md-store"></i>
            <span class="text">Category</span>
          </a>
        </li>
        <li class="menu-item has-submenu">
          <a class="menu-link"><i class="icon material-icons md-shopping_bag"></i>
            <span class="text">Products</span>
          </a>
          <div class="submenu">
            <a href="/admin/addProducts">Product Add</a>
            <a href="/admin/products">Product List</a>
          </div>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/orders">
            <i class="icon material-icons md-shopping_cart"></i>
            <span class="text">Orders</span>
          </a>
        </li>
         <li class="menu-item">
          <a class="menu-link" href="/admin/transactions">
            <i class="icon material-icons md-account_balance_wallet"></i>
            <span class="text">Transactions</span>
          </a>
        </li>
         <li class="menu-item ">
          <a class="menu-link" href="/admin/coupons">
            <i class="icon material-icons md-local_offer"></i>
            <span class="text">Coupons</span>
          </a>
        </li>
         <li class="menu-item">
          <a class="menu-link" href="/admin/sales-report">
            <i class="icon material-icons md-assessment"></i>
            <span class="text">Sales Report</span>
          </a>
          </li>
      </ul>
    </nav>
  </aside>

  <main class="main-wrap">
    <header class="main-header navbar">
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
      </button>
      <div class="col-search mb-3">
        <form class="searchform d-flex" action="/admin/category" method="GET">
          <input type="text" name="q" value="<%= q %>" class="form-control" placeholder="Search categories" />
          <button class="btn btn-light ms-2" type="submit">
            <i class="material-icons md-search"></i>
          </button>
          <% if (q.trim()) { %>
            <a href="/admin/category" class="btn btn-outline-secondary ms-2" style="font-size:1rem;">Clear</a>
            <% } %>
        </form>
      </div>
    </header>
  
    <div class="logout-fixed">
      <ul class="nav">
        <li class="dropdown nav-item">
          <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount">
            <img class="img-xs rounded-circle" src="/assets2/imgs/theme/adminAvatar.svg" alt="Admin">
          </a>
          <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
            <a class="dropdown-item text-danger" href="/admin/logout">
              <i class="material-icons md-exit_to_app"></i>Logout
            </a>
          </div>
        </li>
      </ul>
    </div>
  
    <section class="content-main">
      <div class="content-header d-flex justify-content-between align-items-center mb-4">
        <h2 class="content-title card-title">Category Management</h2>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Add New Category</h5>
          <form action="/admin/addCategory?q=<%= q %>&page=<%= page %>" method="POST" class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Category Name</label>
              <input type="text" name="categoryName" class="form-control" placeholder="Enter category name" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">Description</label>
              <input type="text" name="categoryDescription" class="form-control" placeholder="Enter description"
                required />
            </div>
            <div class="col-md-2">
              <label class="form-label">Status</label>
              <select name="status" class="form-select" required>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
            <div class="d-flex justify-content-center">
              <button type="submit" class="btn btn-primary btn-sm">
                <i class="material-icons md-add_box mt-1" style="font-size:1.2rem;"></i>
                <span style="font-size:0.85rem;">Add</span>
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h4 class="card-title">All Categories</h4>
          <div class="table-wrap">
            <table class="table table-custom align-middle mb-0">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Status</th>
                  <th>Count</th>
                  <th>Offer</th>
                  <th>Created At</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (categories.length===0) { %>
                  <tr>
                    <td colspan="8" class="text-center text-warning py-3">No categories found.</td>
                  </tr>
                  <% } else { %>
                    <% categories.forEach((cat, i)=>{ %>
                      <tr id="view-<%= cat._id %>">
                        <td>
                          <%= skip + i + 1 %>
                        </td>
                        <td>
                          <%= cat.categoryName %>
                        </td>
                        <td>
                          <%= cat.categoryDescription %>
                        </td>
                        <td>
                          <%= cat.status %>
                        </td>
                        <td>
                          <%= cat.itemCount || 0 %>
                        </td>
                        <td>
                          <% if (cat.categoryOffer && cat.categoryOffer > 0) { %>
                            <span class="offer-badge">
                              <%= cat.categoryOffer %>% Off
                              <button class="remove-offer-btn" onclick="removeOffer('<%= cat._id %>')">×</button>
                            </span>
                          <% } else { %>
                            <button class="add-offer-btn" onclick="openOfferModal('<%= cat._id %>', '<%= cat.categoryName %>')">
                              Add Offer
                            </button>
                          <% } %>
                        </td>
                        <td>
                          <%= new Date(cat.createdAt).toLocaleDateString() %>
                        </td>
                        <td class="text-end">
                          <button type="button" class="btn btn-sm btn-outline-primary me-1"
                            onclick="toggleEdit('<%= cat._id %>')">Edit</button>
                          <form
                            action="/admin/toggleStatus/<%= cat._id %>?q=<%= q %>&page=<%= page %>"
                            method="POST"
                            class="d-inline"
                          >
                            <% if (cat.status === 'active') { %>
                              <button type="submit" class="btn btn-sm btn-outline-danger">
                                Deactivate
                              </button>
                            <% } else { %>
                              <button type="submit" class="btn btn-sm btn-outline-success">
                                Activate
                              </button>
                            <% } %>
                          </form>
                        </td>
                      </tr>
                      <tr id="edit-<%= cat._id %>" style="display:none;">
                        <td>
                          <%= skip + i + 1 %>
                        </td>
                        <td><input form="edit-<%= cat._id %>-form" type="text" name="categoryName"
                            value="<%= cat.categoryName %>" class="form-control form-control-sm" required /></td>
                        <td><input form="edit-<%= cat._id %>-form" type="text" name="categoryDescription"
                            value="<%= cat.categoryDescription %>" class="form-control form-control-sm" required /></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="text-end">
                          <div class="d-flex justify-content-end align-items-center gap-2">
                            <form id="edit-<%= cat._id %>-form"
                              action="/admin/editCategory/<%= cat._id %>?q=<%= q %>&page=<%= page %>" method="POST"
                              onsubmit="return validateEditForm(this)">
                              <button type="submit" class="btn btn-sm btn-success py-1 px-2">Save</button>
                            </form>
                            <button type="button" class="btn btn-sm btn-outline-secondary py-1 px-2"
                              onclick="toggleEdit('<%= cat._id %>')">Cancel</button>
                          </div>
                        </td>
                      </tr>
                      <% }) %>
                        <% } %>
              </tbody>
            </table>
          </div>

          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mt-4">
              <% if (page> 1) { %>
                <li class="page-item"><a class="page-link"
                    href="/admin/category?q=<%= q %>&page=<%= page-1 %>&limit=<%= limit %>">Prev</a></li>
                <% } else { %>
                  <li class="page-item disabled"><span class="page-link">Prev</span></li>
                  <% } %>
                    <% for (let p=1; p <=totalPages; p++) { %>
                      <li class="page-item <%= p===page?'active':''%>"><a class="page-link"
                          href="/admin/category?q=<%= q %>&page=<%= p %>&limit=<%= limit %>">
                          <%= p %>
                        </a></li>
                      <% } %>
                        <% if (page < totalPages) { %>
                          <li class="page-item"><a class="page-link"
                              href="/admin/category?q=<%= q %>&page=<%= page+1 %>&limit=<%= limit %>">Next</a></li>
                          <% } else { %>
                            <li class="page-item disabled"><span class="page-link">Next</span></li>
                            <% } %>
            </ul>
          </nav>
        </div>
      </div>
    </section>
    <footer class="main-footer font-xs text-center py-3">
      <div>&copy;
        <script>document.write(new Date().getFullYear())</script> Kaizen Street. All rights reserved.
      </div>
    </footer>
  </main>
 
  <div class="modal fade" id="offerModal" tabindex="-1" aria-labelledby="offerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="offerModalLabel">Add Offer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="offerForm" method="POST">
          <div class="modal-body">
            <div class="mb-3">
              <label for="categoryName" class="form-label">Category</label>
              <input type="text" class="form-control" id="categoryNameDisplay" readonly>
            </div>
            <div class="mb-3">
              <label for="discountPercentage" class="form-label">Discount %</label>
              <input type="number" class="form-control" id="discountPercentage" name="categoryOffer" 
                     min="1" max="100" required placeholder="Enter discount percentage">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Offer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="/assets2/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="/assets2/js/vendors/bootstrap.bundle.min.js"></script>
  <script src="/assets2/js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script>
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('offcanvas_aside');
    const overlay = document.getElementById('screenOverlay');

    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', function (e) {
        e.preventDefault();
        sidebar.classList.toggle('show');
        overlay.classList.toggle('show');
      });
    }

    if (overlay) {
      overlay.addEventListener('click', function () {
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
      });
    }

    document.querySelectorAll('.menu-link').forEach(link => {
      link.addEventListener('click', function () {
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
      });
    });

  </script>
  
  <script>
    function toggleEdit(id) {
      const viewRow = document.getElementById(`view-${id}`);
      const editRow = document.getElementById(`edit-${id}`);
      if (!viewRow || !editRow) return;
      viewRow.style.display = viewRow.style.display === 'none' ? '' : 'none';
      editRow.style.display = editRow.style.display === 'none' ? '' : 'none';
    }

    function openOfferModal(categoryId, categoryName) {
      document.getElementById('categoryNameDisplay').value = categoryName;
      document.getElementById('offerForm').action = `/admin/addCategoryOffer/${categoryId}?q=<%= q %>&page=<%= page %>`;
      const modal = new bootstrap.Modal(document.getElementById('offerModal'));
      modal.show();
    }

    function removeOffer(categoryId) {
      Swal.fire({
        title: 'Remove Offer?',
        text: 'Are you sure you want to remove this offer?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, remove it!',
        customClass: {
          popup: 'swal-responsive'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/admin/removeCategoryOffer/${categoryId}?q=<%= q %>&page=<%= page %>`;
          document.body.appendChild(form);
          form.submit();
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      const urlParams = new URLSearchParams(window.location.search);
      const successMessage = urlParams.get('success');
      const errorMessage = urlParams.get('error');

      if (successMessage) {
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: successMessage,
          timer: 3000,
          showConfirmButton: false,
          customClass: {
            popup: 'swal-responsive'
          }
        });
        window.history.replaceState({}, document.title, window.location.pathname + '?q=<%= q %>&page=<%= page %>');
      }

      if (errorMessage) {
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: errorMessage,
          timer: 4000,
          showConfirmButton: false,
          customClass: {
            popup: 'swal-responsive'
          }
        });
        window.history.replaceState({}, document.title, window.location.pathname + '?q=<%= q %>&page=<%= page %>');
      }
    });
  </script>

</body>

</html>