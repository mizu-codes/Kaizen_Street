<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Kaizen Product List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" type="image/x-icon" href="/assets2/imgs/theme/kaizenicon.svg">
  <link href="/assets2/css/main.css" rel="stylesheet" type="text/css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f0f0f0;
    }

    .content-title {
      font-size: 1.75rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .btn-light {
      background-color: #f4f5f9;
    }

    .btn-light:hover {
      background-color: #088178;
    }

    .table-wrap {
      overflow-x: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 2rem;
    }

    .table-custom {
      margin-bottom: 0;
      font-size: 0.9rem;
      min-width: 1200px;
    }

    .table-custom th {
      background: linear-gradient(90deg, #6c63ff, #8f94fb);
      color: #fff;
      border: none;
      padding: 0.75rem 0.5rem;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }

    .table-custom tbody tr {
      transition: all 0.3s ease;
      border-bottom: 1px solid #f0f0f0;
    }

    .table-custom tbody tr:hover {
      background-color: #f8f9ff;
      transform: scale(1.002);
      box-shadow: 0 2px 8px rgba(108, 99, 255, 0.1);
    }

    .table-custom td {
      padding: 0.75rem 0.5rem;
      vertical-align: middle;
      border: none;
    }

    .table-custom th:nth-child(1) {
      width: 50px;
    }

    .table-custom th:nth-child(2) {
      width: 200px;
    }

    .table-custom th:nth-child(3) {
      width: 120px;
    }

    .table-custom th:nth-child(4) {
      width: 100px;
    }

    .table-custom th:nth-child(5) {
      width: 80px;
    }

    .table-custom th:nth-child(6) {
      width: 100px;
    }

    .table-custom th:nth-child(7) {
      width: 140px;
    }

    .table-custom th:nth-child(8) {
      width: 100px;
    }

    .table-custom th:nth-child(9) {
      width: 80px;
    }

    .table-custom th:nth-child(10) {
      width: 80px;
    }

    .table-custom th:nth-child(11) {
      width: 150px;
    }

    .product-name {
      font-weight: 600;
      color: #333;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .product-name:hover {
      overflow: visible;
      white-space: normal;
      word-wrap: break-word;
    }

    .category-name {
      color: #6c757d;
      font-size: 0.85rem;
    }

    .stock-summary {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .stock-total {
      font-weight: 600;
      color: #333;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
    }

    .stock-total.in-stock {
      color: #28a745;
    }

    .stock-total.low-stock {
      color: #ffc107;
    }

    .stock-total.out-of-stock {
      color: #dc3545;
    }

    .stock-details {
      font-size: 0.75rem;
      color: #6c757d;
      line-height: 1.2;
    }

    .size-display {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      max-width: 120px;
    }

    .size-tag {
      background: #e9ecef;
      color: #495057;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .price-column {
      min-width: 110px;
      text-align: center;
    }

    .original-price {
      font-weight: 600;
      color: #333;
    }

    .discount-price {
      color: #28a745;
      font-weight: 600;
      font-size: 0.9em;
    }

    .discount-badge {
      background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
      color: white;
      font-size: 0.65rem;
      padding: 0.2rem 0.4rem;
      border-radius: 10px;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-badge {
      padding: 0.35rem 0.75rem;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: capitalize;
      display: inline-flex;
      align-items: center;
    }

    .status-badge.blocked {
      background-color: #dc3545;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .status-badge.active {
      background-color: #28a745;
      color: #fff;
    }

    .btn-sm {
      font-size: 0.75rem;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.3s ease;
      margin: 0 0.1rem;
    }

    .btn-outline-primary {
      border-color: #6c63ff;
      color: #6c63ff;
    }

    .btn-outline-primary:hover {
      background-color: #6c63ff;
      border-color: #6c63ff;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(108, 99, 255, 0.3);
    }

    .btn-outline-success {
      border-color: #28a745;
      color: #28a745;
    }

    .btn-outline-success:hover {
      background-color: #28a745;
      border-color: #28a745;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    .btn-outline-danger {
      border-color: #dc3545;
      color: #dc3545;
    }

    .btn-outline-danger:hover {
      background-color: #dc3545;
      border-color: #dc3545;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    .pagination {
      margin-top: 2rem;
    }

    .pagination .page-link {
      color: #6c63ff;
      border-radius: 8px;
      border: 2px solid #6c63ff;
      margin: 0 4px;
      padding: 0.45rem 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .pagination .page-link:hover {
      background-color: #6c63ff;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(108, 99, 255, 0.3);
    }

    .pagination .page-item.active .page-link {
      background-color: #6c63ff;
      border-color: #6c63ff;
      color: white;
      box-shadow: 0 4px 8px rgba(108, 99, 255, 0.3);
    }

    .pagination .page-item.disabled .page-link {
      color: #aaa;
      border-color: #ddd;
      background-color: #f9f9f9;
      cursor: not-allowed;
    }

    .pagination .page-item.disabled .page-link:hover {
      transform: none;
      box-shadow: none;
    }

    .modal-dialog {
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      max-width: 900px;
    }

    .modal-dialog.modal-xl {
      max-width: 950px;
      margin: 0.5rem auto;
    }

    .modal-content {
      border: none;
      border-radius: 12px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.25rem 1.75rem 1rem;
      border-bottom: none;
      position: relative;
    }

    .modal-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
    }

    .modal-title {
      font-weight: 700;
      font-size: 1.4rem;
      margin: 0;
      letter-spacing: -0.3px;
      color: #2d3748;
    }

    .btn-close {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      opacity: 0.8;
      transition: all 0.3s ease;
      filter: invert(1);
    }

    .btn-close:hover {
      background: rgba(255, 255, 255, 0.3);
      opacity: 1;
      transform: scale(1.05);
    }

    .modal-body {
      padding: 1.5rem;
      background: #fafbfc;
      max-height: none;
      overflow-y: visible;
    }

    .image-upload-section {
      background: white;
      border-radius: 10px;
      padding: 1.25rem;
      margin-bottom: 1.25rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid #e8ecf4;
    }

    .image-upload-section h6 {
      color: #2d3748;
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
    }

    .image-upload-section h6::before {
      margin-right: 0.4rem;
      font-size: 1rem;
    }

    .image-upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .image-upload-item {
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      background: #f7fafc;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .image-upload-item:hover {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
      transform: translateY(-1px);
    }

    .image-upload-item.has-image {
      border-style: solid;
      border-color: #48bb78;
      background: linear-gradient(135deg, rgba(72, 187, 120, 0.05), rgba(56, 178, 172, 0.05));
    }

    .image-upload-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .image-upload-label {
      display: block;
      cursor: pointer;
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 0.3rem;
    }

    .upload-placeholder {
      color: #718096;
      font-weight: 500;
    }

    .upload-placeholder i {
      display: block;
      margin-bottom: 0.4rem;
      font-size: 2rem;
      color: #a0aec0;
    }

    .image-preview {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .image-remove-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fc8181, #f56565);
      color: white;
      border: none;
      font-size: 0.7rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(245, 101, 101, 0.3);
      transition: all 0.3s ease;
    }

    .image-remove-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 3px 8px rgba(245, 101, 101, 0.4);
    }

    .crop-btn {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      background: linear-gradient(135deg, #4299e1, #3182ce);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.3rem 0.6rem;
      font-size: 0.7rem;
      cursor: pointer;
      font-weight: 500;
      box-shadow: 0 2px 6px rgba(66, 153, 225, 0.3);
      transition: all 0.3s ease;
    }

    .crop-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(66, 153, 225, 0.4);
    }

    .crop-modal .modal-dialog {
      max-width: 90vw;
      max-height: 90vh;
    }

    .crop-container {
      max-height: 60vh;
      overflow: hidden;
    }

    .crop-container img {
      max-width: 100%;
    }

    .crop-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .aspect-ratio-btn {
      padding: 5px 10px;
      border: 1px solid #dee2e6;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .aspect-ratio-btn.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }

    .modal-body .form-label {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
    }

    .modal-body .form-control,
    .modal-body .form-select {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 0.65rem 0.9rem;
      transition: all 0.3s ease;
      background: white;
      font-size: 0.9rem;
    }

    .modal-body .form-control:focus,
    .modal-body .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
      outline: none;
    }

    .modal-body .form-control::placeholder {
      color: #a0aec0;
    }

    .pricing-section {
      background: white;
      border-radius: 10px;
      padding: 1.25rem;
      margin-bottom: 1.25rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid #e8ecf4;
    }

    .pricing-section h6 {
      color: #2d3748;
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
    }

    .pricing-section h6::before {
      content: 'ðŸ’°';
      margin-right: 0.4rem;
      font-size: 1rem;
    }

    .price-calculator {
      background: linear-gradient(135deg, #f7fafc, #edf2f7);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      border: 1px solid #e2e8f0;
    }

    .price-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 1rem;
      background: white;
      border-radius: 6px;
      margin-top: 0.5rem;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
    }

    .discount-preview {
      color: #38a169;
      font-weight: 700;
      font-size: 1rem;
    }

    .savings-display {
      color: #28a745;
      font-weight: bold;
      font-size: 0.85rem;
      margin-top: 0.4rem;
    }

    .modal-body .row {
      margin-bottom: 1rem;
    }

    .modal-body .row:last-child {
      margin-bottom: 0;
    }

    .modal-body input[type="number"] {
      text-align: center;
      font-weight: 500;
    }

    .modal-body textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-body textarea::placeholder {
      color: #a0aec0;
      line-height: 1.4;
    }

    .modal-footer {
      padding: 1.25rem 1.75rem;
      border-top: 1px solid #e2e8f0;
      background: white;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    .modal-footer .btn {
      padding: 0.6rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      border: none;
    }

    .modal-footer .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
      border: 2px solid #e2e8f0;
    }

    .modal-footer .btn-secondary:hover {
      background: #cbd5e0;
      color: #2d3748;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }

    .modal-footer .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: 2px solid transparent;
    }

    .modal-footer .btn-primary:hover {
      background: linear-gradient(135deg, #5a67d8, #6b46c1);
      transform: translateY(-1px);
      box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
    }

    .modal-body::-webkit-scrollbar {
      display: none;
    }

    .modal.fade .modal-dialog {
      transform: scale(0.9) translateY(-30px);
      transition: all 0.25s ease;
    }

    .modal.show .modal-dialog {
      transform: scale(1) translateY(0);
    }

    .alert {
      border: none;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      font-weight: 500;
    }

    .alert-success {
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .alert-danger {
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(231, 76, 60, 0.1));
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    .fas {
      margin-right: 0.25rem;
    }

    @media (max-width: 768px) {
      .content-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .table-wrap {
        font-size: 0.8rem;
      }

      .table-custom {
        min-width: 1000px;
      }

      .btn-sm {
        font-size: 0.7rem;
        padding: 0.3rem 0.6rem;
        margin: 0.1rem;
      }

      .pagination .page-link {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
      }

      .modal-dialog.modal-xl {
        max-width: 95%;
        margin: 0.5rem;
      }

      .modal-header {
        padding: 1.5rem 1.5rem 1rem;
      }

      .modal-body {
        padding: 1.5rem;
      }

      .modal-footer {
        padding: 1.5rem;
      }

      .search-filter-form {
        padding: 1rem;
      }

      .image-upload-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .image-upload-section,
      .pricing-section {
        padding: 1.5rem;
      }

      .size-display {
        max-width: 80px;
      }

      .product-name {
        max-width: 120px;
      }
    }

    @media (max-width: 576px) {

      .table-custom th,
      .table-custom td {
        padding: 0.5rem 0.25rem;
      }

      .pagination .page-link {
        margin: 0 1px;
        padding: 0.4rem 0.6rem;
      }
    }

    .table-custom tbody tr.loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .btn:focus,
    .form-control:focus,
    .form-select:focus,
    .page-link:focus {
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(108, 99, 255, 0.25);
    }

    * {
      transition: all 0.3s ease;
    }

    .table-wrap::-webkit-scrollbar {
      height: 8px;
    }

    .table-wrap::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .table-wrap::-webkit-scrollbar-thumb {
      background: #6c63ff;
      border-radius: 4px;
    }

    .table-wrap::-webkit-scrollbar-thumb:hover {
      background: #5a52e6;
    }

    .input-group {
      background-color: #f6f7fa;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }

    .input-group .form-control {
      border: none;
      background-color: transparent;
      padding: 12px 16px;
      font-size: 16px;
      color: #333;
    }

    .input-group .form-control::placeholder {
      color: #b0b9c8;
    }

    .input-group .form-control:focus {
      box-shadow: none;
      outline: none;
    }
  </style>
</head>

<body>

  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
      <a href="/admin" class="brand-wrap">
        <img src="/assets2/imgs/theme/kaizenlogoo.svg" class="logo" alt="Kaizen Dashboard">
      </a>
      <div>
        <button class="btn btn-icon btn-aside-minimize">
          <i class="text-muted material-icons md-menu_open"></i>
        </button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item">
          <a class="menu-link" href="/admin">
            <i class="icon material-icons md-home"></i>
            <span class="text">Dashboard</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/user"> <i class="icon material-icons md-person"></i>
            <span class="text">Customers</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/category"> <i class="icon material-icons md-store"></i>
            <span class="text">Category</span>
          </a>
        </li>
        <li class="menu-item has-submenu active">
          <a class="menu-link"><i class="icon material-icons md-shopping_bag"></i>
            <span class="text">Products</span>
          </a>
          <div class="submenu">
            <a href="/admin/addProducts">Product Add</a>
            <a href="/admin/products">Product List</a>
          </div>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/orders">
            <i class="icon material-icons md-shopping_cart"></i>
            <span class="text">Orders</span>
          </a>
        </li>
         <li class="menu-item">
          <a class="menu-link" href="/admin/transactions">
            <i class="icon material-icons md-account_balance_wallet"></i>
            <span class="text">Transactions</span>
          </a>
        </li>
        <li class="menu-item ">
          <a class="menu-link" href="/admin/coupons">
            <i class="icon material-icons md-local_offer"></i>
            <span class="text">Coupons</span>
          </a>
        </li>
         <li class="menu-item">
          <a class="menu-link" href="/admin/sales-report">
            <i class="icon material-icons md-assessment"></i>
            <span class="text">Sales Report</span>
          </a>
          </li>
      </ul>
    </nav>
  </aside>

  <main class="main-wrap">
    <header class="main-header navbar">
      <div class="col-search w-100">
        <form class="row d-flex align-items-center" method="GET" action="/admin/products">
          <div class="col-md-5">
            <div class="input-group">
              <input type="text" name="search" value="<%= search %>" class="form-control"
                placeholder="Search productsâ€¦" />
              <button class="btn btn-light bg" type="submit"> <i class="material-icons md-search"></i></button>
            </div>
          </div>

          <div class="col-md-2">
            <% if (search) { %>
              <a href="?page=1&limit=<%= limit %>" class="btn btn-outline-secondary ms-2">Clear</a>
              <% } %>
          </div>
        </form>
      </div>
    </header>


    <section class="content-main">
      <div class="content-header d-flex justify-content-between align-items-center mb-4">
        <h2 class="content-title card-title">Product Management</h2>
      </div>
    
      <div class="container">
        <div class="table-wrap">
          <table class="table table-custom align-middle mb-0">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Category</th>
                <th>Regular Price</th>
                <th>Discount %</th>
                <th>Discount Price</th>
                <th>Stock</th>
                <th>Size</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody data-page="<%= currentPage %>" data-limit="<%= limit %>" data-search="<%= search %>">
              <% products.forEach((p, i)=> { %>
                <tr data-id="<%= p._id %>" data-name="<%= p.productName.replace(/" /g, '&quot;' ) %>"
                  data-description="<%= (p.description||'').replace(/"/g,'&quot;') %>"
                    data-price="<%= p.regularPrice %>"
                      data-discount-percent="<%= p.productOffer||0 %>"
                        data-discount-price="<%= p.discountPrice||p.regularPrice %>"
                          data-category="<%= p.category?._id||'' %>"
                            data-stock='<%- JSON.stringify(p.stock || {}) %>'
                              data-size='<%- JSON.stringify(p.size || []) %>'
                                data-status="<%= p.status %>"
                                  data-specifications="<%= (p.specifications||'').replace(/"/g,'&quot;') %>"
                                    data-images='<%- JSON.stringify(p.productImage || []) %>'
                                      >
                                      <td>
                                        <%= (currentPage - 1) * limit + i + 1 %>
                                      </td>
                                      <td>
                                        <%= p.productName %>
                                      </td>
                                      <td>
                                        <%= p.category?.categoryName || 'â€”' %>
                                      </td>
                                      <td class="price-column">â‚¹ <%= p.regularPrice.toFixed(2) %>
                                      </td>
                                      <td>
                                        <% const discountNum=parseFloat(p.productOffer) || 0; %>
                                          <% if (discountNum> 0) { %>
                                            <span class="discount-badge">
                                              <%= discountNum %>% OFF
                                            </span>
                                            <% } else { %>â€”<% } %>
                                      </td>
                                      <td class="price-column">
                                        <% if (typeof p.discountPrice==='number' ) { %>
                                          â‚¹ <%= p.discountPrice.toFixed(2) %>
                                            <% } else { %>â€”<% } %>
                                      </td>
                                      <td>
                                        <div class="stock-tooltip">
                                          <div class="stock-summary">
                                            <% let totalStock=0; if (p.stock) {
                                              totalStock=Object.values(p.stock).reduce((sum, qty)=> sum +
                                              (parseInt(qty) || 0), 0);
                                              }
                                              let stockClass = totalStock === 0 ? 'out-of-stock' : totalStock <= 2
                                                ? 'low-stock' : 'in-stock' ; let stockIcon=totalStock===0
                                                ? 'fas fa-exclamation-triangle' : totalStock <=2
                                                ? 'fas fa-exclamation-circle' : 'fas fa-check-circle' ; %>
                                                <div class="stock-total <%= stockClass %>">
                                                  <i class="<%= stockIcon %> me-1"></i>
                                                  Total: <%= totalStock %>
                                                </div>
                                          </div>
                                        </div>
                                      </td>
    
                                      <td>
                                        <div class="size-display">
                                          <% if (Array.isArray(p.size)) { %>
                                            <% p.size.forEach(size=> { %>
                                              <span class="size-tag">
                                                <%= size %>
                                              </span>
                                              <% }) %>
                                                <% } else if (p.size) { %>
                                                  <span class="size-tag">
                                                    <%= p.size %>
                                                  </span>
                                                  <% } %>
                                        </div>
                                      </td>
                                      <td>
                                        <span class="status-badge <%= p.isBlocked ? 'blocked' : p.status.toLowerCase() %>">
                                          <%= p.isBlocked ? 'Blocked' : p.status %>
                                        </span>
                                      </td>
    
                                      <td>
                                        <div class="d-flex align-items-center">
    
                                          <button class="btn btn-sm btn-outline-primary btn-edit" data-bs-toggle="modal"
                                            data-bs-target="#editProductModal">
                                            Edit
                                          </button>
    
                                          <button
                                            class="btn btn-sm ms-2 toggle-block-btn btn-outline-<%= p.isBlocked ? 'success' : 'danger' %>"
                                            data-product-id="<%= p._id %>" data-product-name="<%= p.productName %>"
                                            data-is-blocked="<%= p.isBlocked %>">
                                            <%= p.isBlocked ? 'Unblock' : 'Block' %>
                                          </button>
                                        </div>
                                      </td>
                </tr>
                <% }) %>
            </tbody>
          </table>
        </div>
    
    
        <nav>
          <ul class="pagination justify-content-center mt-4">
            <li class="page-item <%= currentPage === 1 ? " disabled" : "" %>">
              <a class="page-link" href="?page=<%= currentPage - 1 %>&limit=<%= limit %>&search=<%= search %>">&laquo;</a>
            </li>
            <% for (let p=1; p <=totalPages; p++) { %>
              <li class="page-item <%= currentPage === p ? " active" : "" %>">
                <a class="page-link" href="?page=<%= p %>&limit=<%= limit %>&search=<%= search %>">
                  <%= p %>
                </a>
              </li>
              <% } %>
                <li class="page-item <%= currentPage === totalPages ? " disabled" : "" %>">
                  <a class="page-link"
                    href="?page=<%= currentPage + 1 %>&limit=<%= limit %>&search=<%= search %>">&raquo;</a>
                </li>
          </ul>
        </nav>
      </div>
    
    
      <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
          <form id="editProductForm" method="POST" class="modal-content" action="" enctype="multipart/form-data">
            <div class="modal-header">
              <h5 class="modal-title">Edit Product</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
    
              <div class="image-upload-section">
                <h6 class="mb-3">Product Images</h6>
                <div class="image-upload-grid">
    
                  <div class="image-upload-item" id="imageItem1">
                    <input type="file" name="productImages" class="image-upload-input" id="imageInput1" accept="image/*">
                    <label for="imageInput1" class="image-upload-label">
                      <div class="upload-placeholder">
                        <i class="material-icons" style="font-size: 2rem; color: #6c757d;"></i>
                        <div>Click to upload image 1</div>
                      </div>
                    </label>
                    <img class="image-preview" id="imagePreview1" style="display: none;">
                    <button type="button" class="crop-btn" id="cropBtn1" style="display: none;">Crop</button>
                    <button type="button" class="image-remove-btn" id="removeBtn1" style="display: none;">Ã—</button>
                  </div>
    
    
                  <div class="image-upload-item" id="imageItem2">
                    <input type="file" name="productImages" class="image-upload-input" id="imageInput2" accept="image/*">
                    <label for="imageInput2" class="image-upload-label">
                      <div class="upload-placeholder">
                        <i class="material-icons" style="font-size: 2rem; color: #6c757d;"></i>
                        <div>Click to upload image 2</div>
                      </div>
                    </label>
                    <img class="image-preview" id="imagePreview2" style="display: none;">
                    <button type="button" class="crop-btn" id="cropBtn2" style="display: none;">Crop</button>
                    <button type="button" class="image-remove-btn" id="removeBtn2" style="display: none;">Ã—</button>
                  </div>
    
    
                  <div class="image-upload-item" id="imageItem3">
                    <input type="file" name="productImages" class="image-upload-input" id="imageInput3" accept="image/*">
                    <label for="imageInput3" class="image-upload-label">
                      <div class="upload-placeholder">
                        <i class="material-icons" style="font-size: 2rem; color: #6c757d;"></i>
                        <div>Click to upload image 3</div>
                      </div>
                    </label>
                    <img class="image-preview" id="imagePreview3" style="display: none;">
                    <button type="button" class="crop-btn" id="cropBtn3" style="display: none;">Crop</button>
                    <button type="button" class="image-remove-btn" id="removeBtn3" style="display: none;">Ã—</button>
                  </div>
                </div>
    
                <div class="basic-info-section">
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label class="form-label">Product Name</label>
                      <input type="text" name="productName" id="editName" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Category</label>
                      <select name="category" id="editCategory" class="form-select" required>
                        <% categories.forEach(cat=> { %>
                          <option value="<%= cat._id %>">
                            <%= cat.categoryName %>
                          </option>
                          <% }) %>
                      </select>
                    </div>
                  </div>
                </div>
    
                <div class="description-section">
                  <div class="mb-4">
                    <label class="form-label">Description</label>
                    <textarea name="description" id="editDesc" class="form-control" rows="3"></textarea>
                  </div>
                </div>
    
                <div class="specs-section">
                  <div class="mb-4">
                    <label class="form-label">Specifications</label>
                    <textarea name="specifications" id="editSpecifications" class="form-control" rows="5"
                      placeholder="Enter one spec per line, e.g.&#10;Composition: 100% cotton&#10;GSM: 220"></textarea>
                  </div>
                </div>
    
    
    
                <div class="pricing-section">
                  <h6 class="mb-3">Pricing Information</h6>
                  <div class="row">
                    <div class="col-md-4">
                      <label class="form-label">Regular Price (â‚¹)</label>
                      <input type="number" step="0.01" name="regularPrice" id="editPrice" class="form-control" required
                        oninput="calculateDiscount()" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Discount Percentage (%)</label>
                      <input type="number" step="0.01" name="productOffer" id="editDiscountPercent" class="form-control"
                        min="0" max="100" oninput="calculateDiscount()" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Discount Price (â‚¹)</label>
                      <input type="number" step="0.01" name="discountPrice" id="editDiscountPrice" class="form-control"
                        readonly />
                    </div>
                  </div>
                  <div class="price-calculator">
                    <div class="price-display">
                      <span>Calculated Savings:</span>
                      <span class="discount-preview" id="savingsAmount">â‚¹ 0.00</span>
                    </div>
                  </div>
                </div>
    
                <div class="row mb-4">
                  <div class="col-md-8">
                    <label class="form-label">Stock by Size</label>
                    <div class="row">
                      <% ['S','M','L','XL','XXL'].forEach(size=> { %>
                        <div class="col-md-2 mb-2">
                          <label>
                            <%= size %>
                          </label>
                          <input type="number" min="0" name="stock_<%= size %>" id="editStock_<%= size %>"
                            class="form-control" value="0" />
                        </div>
                        <% }) %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Update Product</button>
            </div>
          </form>
        </div>
      </div>
    
      <div class="modal fade crop-modal" id="cropModal" tabindex="-1" data-bs-focus="false">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Crop Image</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="crop-container">
                <img id="cropImage" style="max-width: 100%;">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="applyCrop">Apply Crop</button>
            </div>
          </div>
        </div>
      </div>
    </section>
      </main>
      <br>
      <footer class="main-footer font-xs text-center py-3">
        <div>&copy;
          <script>document.write(new Date().getFullYear())</script> Kaizen Street. All rights reserved.
        </div>
      </footer>


      <script src="/assets2/js/vendors/jquery-3.6.0.min.js"></script>
      <script src="/assets2/js/vendors/bootstrap.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script src="/assets2/js/main.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

      <script>
        let currentCropper = null;
        let currentImageIndex = null;
        const croppedFiles = {};
        const existingImages = {};
        const removedImages = new Set();

        document.addEventListener('DOMContentLoaded', () => {
          const toggleButtons = document.querySelectorAll('.toggle-block-btn');

          toggleButtons.forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.preventDefault();

              const productId = btn.getAttribute('data-product-id');
              const productName = btn.getAttribute('data-product-name');
              const isBlocked = btn.getAttribute('data-is-blocked') === 'true';
              const actionText = isBlocked ? 'unblock' : 'block';

              const result = await Swal.fire({
                title: `${actionText.charAt(0).toUpperCase() + actionText.slice(1)} Product?`,
                html: `Are you sure you want to <strong>${actionText}</strong> this product?<br><em>"${productName}"</em>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: isBlocked ? '#28a745' : '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: `Yes, ${actionText} it!`,
                cancelButtonText: 'Cancel',
                customClass: {
                  popup: 'animated-popup'
                }
              });

              if (!result.isConfirmed) return;

              Swal.fire({
                title: 'Processing...',
                html: 'Please wait while we update the product status',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                  Swal.showLoading();
                }
              });

              try {
                const currentUrl = new URL(window.location.href);
                const page = currentUrl.searchParams.get('page') || 1;
                const limit = currentUrl.searchParams.get('limit') || 10;
                const search = currentUrl.searchParams.get('search') || '';

                const response = await fetch(`/admin/products/block/${productId}?page=${page}&limit=${limit}&search=${encodeURIComponent(search)}`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  }
                });

                const data = await response.json();

                if (data.success) {
                  await Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: data.message,
                    timer: 1500,
                    showConfirmButton: false,
                    customClass: {
                      popup: 'animated-popup'
                    }
                  });

                  btn.setAttribute('data-is-blocked', data.isBlocked);
                  btn.textContent = data.isBlocked ? 'Unblock' : 'Block';

                  if (data.isBlocked) {
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-outline-success');
                  } else {
                    btn.classList.remove('btn-outline-success');
                    btn.classList.add('btn-outline-danger');
                  }

                  const row = btn.closest('tr');
                  const statusBadge = row.querySelector('.status-badge');
                  if (statusBadge) {
                    statusBadge.textContent = data.isBlocked ? 'Blocked' : 'Active';
                    statusBadge.className = 'status-badge ' + (data.isBlocked ? 'blocked' : 'active');
                  }

                } else {
                  throw new Error(data.message);
                }

              } catch (error) {
                console.error('Error toggling product status:', error);
                Swal.fire({
                  icon: 'error',
                  title: 'Error!',
                  text: error.message || 'Failed to update product status. Please try again.',
                  confirmButtonColor: '#dc3545'
                });
              }
            });
          });
        });

        function calculateDiscount() {
          const regularPrice = parseFloat(document.getElementById('editPrice')?.value) || 0;
          const discountPercent = parseFloat(document.getElementById('editDiscountPercent')?.value) || 0;

          if (regularPrice > 0 && discountPercent > 0) {
            const discountAmount = (regularPrice * discountPercent) / 100;
            const discountPrice = regularPrice - discountAmount;
            document.getElementById('editDiscountPrice').value = discountPrice.toFixed(2);
            document.getElementById('savingsAmount').textContent = `â‚¹ ${discountAmount.toFixed(2)}`;
          } else {
            document.getElementById('editDiscountPrice').value = regularPrice.toFixed(2);
            document.getElementById('savingsAmount').textContent = 'â‚¹ 0.00';
          }
        }

        async function convertImageToBlob(imageUrl) {
          try {
            const response = await fetch(imageUrl);
            if (!response.ok) {
              throw new Error(`Failed to fetch image: ${response.status}`);
            }
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);
            return blobUrl;
          } catch (error) {
            console.error('Error converting image to blob:', error);
            throw error;
          }
        }

        function setupImageUpload(index) {
          const input = document.getElementById(`imageInput${index}`);
          const preview = document.getElementById(`imagePreview${index}`);
          const remove = document.getElementById(`removeBtn${index}`);
          const crop = document.getElementById(`cropBtn${index}`);
          const item = document.getElementById(`imageItem${index}`);
          const label = item.querySelector('.image-upload-label');

          if (!input || !preview || !remove || !crop || !label || !item) {
            console.error(`Missing elements for image upload ${index}`);
            return;
          }

          input.addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
              alert('Please select a valid image file');
              input.value = '';
              return;
            }

            if (file.size > 5 * 1024 * 1024) {
              alert('Image size should not exceed 5MB');
              input.value = '';
              return;
            }

            const reader = new FileReader();
            reader.onload = ev => {
              preview.src = ev.target.result;
              showImagePreview(index);

              croppedFiles[`image${index}`] = file;
              delete existingImages[`image${index}`];
            };
            reader.readAsDataURL(file);
          });

          remove.addEventListener('click', e => {
            e.preventDefault();
            hideImagePreview(index);

            input.value = '';
            delete croppedFiles[`image${index}`];
            delete existingImages[`image${index}`];
            removedImages.add(index);
          });

          crop.addEventListener('click', async (e) => {
            e.preventDefault();
            if (!preview.src) return;

            try {
              const originalText = crop.textContent;
              crop.disabled = true;
              crop.textContent = 'Loading...';

              let imageUrl = preview.src;

              if (!imageUrl.startsWith('blob:') && !imageUrl.startsWith('data:')) {
                imageUrl = await convertImageToBlob(imageUrl);
              }

              currentImageIndex = index;
              openCropModal(imageUrl);

              crop.disabled = false;
              crop.textContent = originalText;

            } catch (error) {
              console.error('Error preparing image for crop:', error);
              alert('Failed to load image for cropping. Please try uploading a new image.');

              crop.disabled = false;
              crop.textContent = originalText;
            }
          });
        }

        function showImagePreview(index) {
          const preview = document.getElementById(`imagePreview${index}`);
          const remove = document.getElementById(`removeBtn${index}`);
          const crop = document.getElementById(`cropBtn${index}`);
          const item = document.getElementById(`imageItem${index}`);
          const label = item.querySelector('.image-upload-label');

          if (preview) preview.style.display = 'block';
          if (remove) remove.style.display = 'block';
          if (crop) crop.style.display = 'block';
          if (label) label.style.display = 'none';
          if (item) item.classList.add('has-image');
          removedImages.delete(index);
        }

        function hideImagePreview(index) {
          const preview = document.getElementById(`imagePreview${index}`);
          const remove = document.getElementById(`removeBtn${index}`);
          const crop = document.getElementById(`cropBtn${index}`);
          const item = document.getElementById(`imageItem${index}`);
          const label = item.querySelector('.image-upload-label');

          if (preview) {
            if (preview.src.startsWith('blob:')) {
              URL.revokeObjectURL(preview.src);
            }
            preview.src = '';
            preview.style.display = 'none';
          }
          if (remove) remove.style.display = 'none';
          if (crop) crop.style.display = 'none';
          if (label) label.style.display = 'block';
          if (item) item.classList.remove('has-image');
        }

        function openCropModal(imageSrc) {
          const cropImage = document.getElementById('cropImage');
          const cropModal = document.getElementById('cropModal');

          if (!cropImage || !cropModal) {
            console.error('Crop modal elements not found');
            return;
          }

          destroyCropper();

          cropImage.src = imageSrc;

          const modal = new bootstrap.Modal(cropModal, {
            backdrop: 'static',
            keyboard: false,
            focus: false
          });

          modal.show();
        }

        function initializeCropper() {
          const cropImage = document.getElementById('cropImage');

          if (!cropImage || !cropImage.src) {
            console.error('Crop image not found or no source');
            return;
          }

          if (cropImage.complete && cropImage.naturalHeight > 0) {
            createCropper();
          } else {
            cropImage.onload = createCropper;
            cropImage.onerror = () => {
              console.error('Failed to load image for cropping');
              alert('Failed to load image for cropping. Please try again.');
            };
          }
        }

        function createCropper() {
          const cropImage = document.getElementById('cropImage');

          try {
            currentCropper = new Cropper(cropImage, {
              aspectRatio: NaN,
              viewMode: 1,
              autoCropArea: 1,
              responsive: true,
              restore: false,
              checkCrossOrigin: false,
              checkOrientation: false,
            });
          } catch (error) {
            console.error('Error initializing cropper:', error);
            alert('Failed to initialize image cropper. Please try again.');
          }
        }

        function destroyCropper() {
          if (currentCropper) {
            try {
              currentCropper.destroy();
            } catch (error) {
              console.error('Error destroying cropper:', error);
            }
            currentCropper = null;
          }
        }

        document.addEventListener('DOMContentLoaded', () => {
          if (typeof Cropper === 'undefined') {
            console.error('Cropper.js is not loaded. Please include it in your HTML.');
          }

          const cropModal = document.getElementById('cropModal');
          if (cropModal) {
            cropModal.addEventListener('shown.bs.modal', () => {
              setTimeout(initializeCropper, 300);
            });

            cropModal.addEventListener('hidden.bs.modal', () => {
              destroyCropper();
              currentImageIndex = null;

              const cropImage = document.getElementById('cropImage');
              if (cropImage) {
                if (cropImage.src.startsWith('blob:')) {
                  URL.revokeObjectURL(cropImage.src);
                }
                cropImage.src = '';
                cropImage.onload = null;
                cropImage.onerror = null;
              }
            });
          }

          const resetCropBtn = document.getElementById('resetCrop');
          if (resetCropBtn) {
            resetCropBtn.addEventListener('click', () => {
              if (currentCropper) {
                currentCropper.reset();
              }
            });
          }


          const applyCropBtn = document.getElementById('applyCrop');
          if (applyCropBtn) {
            applyCropBtn.addEventListener('click', () => {
              if (!currentCropper || !currentImageIndex) {
                alert('No image selected for cropping');
                return;
              }

              try {

                const canvas = currentCropper.getCroppedCanvas({
                  width: 800,
                  height: 800,
                  fillColor: '#fff',
                  imageSmoothingQuality: 'high'
                });

                if (!canvas) {
                  throw new Error('Failed to create cropped canvas');
                }

                canvas.toBlob(blob => {
                  if (!blob) {
                    alert('Failed to process cropped image');
                    return;
                  }

                  const fileName = `product_${Date.now()}_${currentImageIndex}.jpg`;
                  const file = new File([blob], fileName, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                  });

                  croppedFiles[`image${currentImageIndex}`] = file;
                  delete existingImages[`image${currentImageIndex}`];

                  const preview = document.getElementById(`imagePreview${currentImageIndex}`);
                  if (preview) {
                    if (preview.src.startsWith('blob:')) {
                      URL.revokeObjectURL(preview.src);
                    }
                    preview.src = URL.createObjectURL(file);
                  }

                  const modalInstance = bootstrap.Modal.getInstance(cropModal);
                  if (modalInstance) {
                    modalInstance.hide();
                  }
                }, 'image/jpeg', 0.9);
              } catch (error) {
                console.error('Error applying crop:', error);
                alert('Failed to apply crop. Please try again.');
              }
            });
          }

          for (let i = 1; i <= 3; i++) {
            setupImageUpload(i);
          }

          const priceInput = document.getElementById('editPrice');
          const discountInput = document.getElementById('editDiscountPercent');

          if (priceInput) priceInput.addEventListener('input', calculateDiscount);
          if (discountInput) discountInput.addEventListener('input', calculateDiscount);

          const editModal = document.getElementById('editProductModal');
          if (editModal) {
            editModal.addEventListener('shown.bs.modal', async (event) => {
              const btn = event.relatedTarget;
              if (!btn) return;

              const tr = btn.closest('tr');
              if (!tr) return;

              Object.keys(croppedFiles).forEach(key => delete croppedFiles[key]);
              Object.keys(existingImages).forEach(key => delete existingImages[key]);
              removedImages.clear();

              const imageData = tr.getAttribute('data-images');
              let images = [];
              try {
                images = imageData ? JSON.parse(imageData) : [];
              } catch (error) {
                console.error('Error parsing image data:', error);
              }

              for (let i = 1; i <= 3; i++) {
                if (images[i - 1]) {
                  const preview = document.getElementById(`imagePreview${i}`);
                  if (preview) {
                    preview.src = images[i - 1];
                    existingImages[`image${i}`] = images[i - 1];
                    showImagePreview(i);
                  }
                } else {
                  hideImagePreview(i);
                }

                const fileInput = document.getElementById(`imageInput${i}`);
                if (fileInput) fileInput.value = '';
              }

              const fields = {
                editName: tr.getAttribute('data-name') || '',
                editDesc: tr.getAttribute('data-description') || '',
                editPrice: tr.getAttribute('data-price') || '',
                editDiscountPercent: tr.getAttribute('data-discount-percent') || '',
                editDiscountPrice: tr.getAttribute('data-discount-price') || '',
                editCategory: tr.getAttribute('data-category') || '',
                editSpecifications: tr.getAttribute('data-specifications') || ''
              };

              Object.entries(fields).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.value = value;
              });

              const stockRaw = tr.getAttribute('data-stock');
              let parsedStock = {};
              try {
                parsedStock = stockRaw ? JSON.parse(stockRaw) : {};
              } catch (error) {
                console.error('Error parsing stock data:', error);
              }

              ['S', 'M', 'L', 'XL', 'XXL'].forEach(size => {
                const element = document.getElementById(`editStock_${size}`);
                if (element) element.value = parsedStock[size] || 0;
              });

              const form = document.getElementById('editProductForm');
              if (form) {
                const page = tr.parentElement.getAttribute('data-page') || '1';
                const limit = tr.parentElement.getAttribute('data-limit') || '5';
                const search = encodeURIComponent(tr.parentElement.getAttribute('data-search') || '');
                form.action = `/admin/products/edit/${tr.getAttribute('data-id')}?page=${page}&limit=${limit}&search=${search}`;
              }

              calculateDiscount();
            });
          }

          const form = document.getElementById('editProductForm');
          if (form) {
            form.addEventListener('submit', async (e) => {
              e.preventDefault();

              const regularPrice = parseFloat(document.getElementById('editPrice')?.value);
              const discountPercent = parseFloat(document.getElementById('editDiscountPercent')?.value) || 0;
              const stockFields = ['S', 'M', 'L', 'XL', 'XXL'].map(size => {
                const el = document.getElementById(`editStock_${size}`);
                return parseInt(el?.value) || 0;
              });
              const totalStock = stockFields.reduce((a, b) => a + b, 0);

              if (!regularPrice || regularPrice <= 0) {
                alert('Regular price must be greater than 0');
                return;
              }
              if (discountPercent < 0 || discountPercent > 100) {
                alert('Discount percentage must be between 0 and 100');
                return;
              }
              if (totalStock <= 0) {
                alert('At least one size must have stock greater than 0');
                return;
              }

              const hasImages = Object.keys(existingImages).length > 0 || Object.keys(croppedFiles).length > 0;
              if (!hasImages) {
                alert('At least one product image is required');
                return;
              }

              const formData = new FormData(form);

              const fileInputs = form.querySelectorAll('input[type="file"]');
              fileInputs.forEach(input => formData.delete(input.name));

              let hasNewImages = false;
              const finalImageIndexes = [];

              for (let i = 1; i <= 3; i++) {
                if (croppedFiles[`image${i}`]) {
                  formData.append('productImages', croppedFiles[`image${i}`]);
                  finalImageIndexes.push(i);
                  hasNewImages = true;
                } else if (existingImages[`image${i}`] && !removedImages.has(i)) {
                  finalImageIndexes.push(i);
                }
              }

              formData.append('hasNewImages', hasNewImages ? 'true' : 'false');
              formData.append('imageIndexes', JSON.stringify(finalImageIndexes));
              formData.append('existingImages', JSON.stringify(existingImages));

              const submitBtn = form.querySelector('button[type="submit"]');
              if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
              }

              try {
                const res = await fetch(form.action, {
                  method: 'POST',
                  body: formData
                });

                const data = await res.json();

                if (data.success) {
                  const editModal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
                  if (editModal) {
                    editModal.hide();
                  }

                  await Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                  });

                  window.location.href = data.redirectUrl;
                } else {
                  throw new Error(data.message);
                }
              } catch (err) {
                console.error('Update failed:', err);

                Swal.fire({
                  icon: 'error',
                  title: 'Update Failed',
                  text: err.message || 'An error occurred while updating the product'
                });

                if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = 'Update Product';
                }
              }
            });
          }
        });

        window.addEventListener('beforeunload', () => {
          for (let i = 1; i <= 3; i++) {
            const preview = document.getElementById(`imagePreview${i}`);
            if (preview && preview.src.startsWith('blob:')) {
              URL.revokeObjectURL(preview.src);
            }
          }

          const cropImage = document.getElementById('cropImage');
          if (cropImage && cropImage.src.startsWith('blob:')) {
            URL.revokeObjectURL(cropImage.src);
          }

          destroyCropper();
        });
      </script>

</body>

</html>